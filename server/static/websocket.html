<!DOCTYPE HTML>
<html>
<head>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
<canvas id="myCanvas" width="600" height="600"></canvas>
<script>
    //  setup websocket with callbacks
    var ws = new WebSocket('ws://localhost:8080/ws');
    ws.onopen = function() {
        console.log('CONNECTED');
    };
    ws.onclose = function() {
        console.log('DISCONNECTED');
    };
    ws.onmessage = function(event) {
        balls.push(spawnBall(event.data));
    };

    function Vector2D(x, y) {
        this.x = x || 0;
        this.y = y || 0;
    }

    Vector2D.prototype = {
        setTo: function (vector) {
            this.x = vector.x;
            this.y = vector.y;
        },
        add: function (vector) {
            this.x += vector.x;
            this.y += vector.y;
        },
        scale: function (scalar) {
            this.x *= scalar;
            this.y *= scalar;
        },
        minus: function (vector) {
            return new Vector2D(this.x - vector.x, this.y - vector.y);
        },
        length: function () {
            return Math.sqrt(this.x * this.x + this.y * this.y);
        },
        normalize: function() {
            var length = this.length();
            this.x /= length;
            this.y /= length;
        }
    };

    var canvas = document.getElementById('myCanvas');
    var context = canvas.getContext('2d');
    var centerX = canvas.width / 2;
    var centerY = canvas.height / 2;

    var populars = {};

    var colors = ['aqua', 'yellow', 'blue', 'fuchsia', 'green',
        'lime', 'maroon', 'navy', 'olive', 'orange', 'purple', 'red',
        'silver', 'teal', 'white', 'gray'];

    var balls = [];

    function getPopular(hashtag) {
        var popular = populars[hashtag];

        if (!popular) {
            var num_hashtags = Object.keys(populars).length,
                color = colors[num_hashtags % colors.length];

            popular = populars[hashtag] = new Ball(color, 0, 0, hashtag);
            changePopularsDestination();
        }

        return popular;
    }

    function getPopulars() {
        return Object.keys(populars).map(function(key) {
            return populars[key];
        });
    }

    function changePopularsDestination() {
        var populars = getPopulars(),
            num = populars.length;

        populars.forEach(function (popular, index) {
            popular.destination = new Vector2D(
                centerX + Math.cos(index / num * Math.PI*2) * centerX/2,
                centerY + Math.sin(index / num * Math.PI*2) * centerY/2
            );
        });

    }

    function spawnBall(destination) {
        var popular = getPopular(destination);
        return new Ball(popular.color, centerX, centerY, popular);
    }

    function Ball(color, x, y, destination) {
        Vector2D.call(this, x, y);
        this.color = color;
        this.speed = 5;
        this.radius = 10;
        this.text = destination || '';
        this.destination = destination;
    }

    Ball.prototype = new Vector2D();

    Ball.prototype.move = function () {

        // if ball has no destination
        if (!this.destination) {
            // nothing to do here
            return true;
        }

        var vect = this.destination.minus(this);
        var distance = vect.length();

        // destination reached
        if (distance === 0) {
            this.destination.radius++;
            this.destination = null;
            // say goodbye to this world!
            return false;
        }

        // last movement
        if (distance < this.speed) {
            this.setTo(this.destination);
            return true;
        }

        vect.normalize();
        vect.scale(this.speed);

        this.add(vect);

        return true;
    };

    Ball.prototype.draw = function (context) {
        context.beginPath();
        context.arc(this.x, this.y, this.radius, 0, 2 * Math.PI, false);
        context.fillStyle = this.color;
        context.fill();
        context.font="20px Georgia";
        context.fillStyle = 'black';
        context.fillText(this.text, this.x - this.text.length/2 * 9, this.y + this.radius + 23);
        context.lineWidth = 3;
        context.strokeStyle = '#003300';
        context.stroke();
    };

    Ball.prototype.constructor = Ball;

    function loop() {
        context.clearRect(0, 0, canvas.width, canvas.height);

        loopBody();

        window.requestAnimationFrame(loop);
    }

    function loopBody() {
        var populars = getPopulars();

        balls = balls.filter(function(ball) { return ball.move(); });
        populars.forEach(function(ball) { ball.move(); });

        balls.forEach(function(ball) { ball.draw(context); });
        populars.forEach(function(ball) { ball.draw(context); });
    }

    loop();

</script>
</body>
</html>     
